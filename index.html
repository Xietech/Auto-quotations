<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°åˆ·æ™ºèƒ½æŠ¥ä»·ç³»ç»Ÿ - æ——èˆ°ç‰ˆ</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #4b5563;
            --accent: #10b981;
            --bg: #f3f4f6;
            --card: #ffffff;
            --border: #e5e7eb;
            --warn: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: #1f2937;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 950px;
            margin: 0 auto;
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* --- Header æ ·å¼æ›´æ–° --- */
        header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center; /* å±…ä¸­å¯¹é½ï¼Œå¦‚éœ€å·¦å¯¹é½æ”¹ä¸º flex-start */
            gap: 15px;
        }

        .logo-img {
            height: 48px; /* Logoé«˜åº¦æ§åˆ¶ */
            width: auto;
            background: rgba(255, 255, 255, 0.2); /* ä»…ä½œå±•ç¤ºç”¨çš„åŠé€æ˜èƒŒæ™¯ */
            padding: 5px;
            border-radius: 6px;
            backdrop-filter: blur(5px);
        }

        .header-text {
            display: flex;
            flex-direction: column;
        }

        .header-text h1 { margin: 0; font-size: 22px; line-height: 1.2; font-weight: 700; }
        .header-text p { margin: 2px 0 0; font-size: 13px; opacity: 0.9; font-weight: 400; }
        /* --------------------- */

        .tabs { display: flex; border-bottom: 1px solid var(--border); }
        .tab-btn {
            flex: 1;
            padding: 16px;
            background: #f9fafb;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--secondary);
            transition: 0.2s;
        }
        .tab-btn.active {
            background: white;
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .content { display: flex; flex-wrap: wrap; }
        .form-panel { flex: 1.2; padding: 30px; min-width: 320px; }
        .visual-panel { 
            flex: 0.8; 
            padding: 30px; 
            background: #f8fafc; 
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-width: 300px;
        }

        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            box-sizing: border-box;
            background: #fff;
            transition: background 0.2s;
        }
        
        input:disabled, select:disabled { 
            background: #f3f4f6; 
            color: #9ca3af; 
            cursor: not-allowed; 
            border-color: #e5e7eb;
        }

        .preset-tags {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .tag {
            font-size: 12px;
            background: #eff6ff;
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 12px;
            cursor: pointer;
            border: 1px solid #bfdbfe;
            transition: all 0.2s;
        }
        .tag:hover { background: var(--primary); color: white; border-color: var(--primary); }

        .note { font-size: 12px; color: #6b7280; margin-top: 4px; }
        
        .warn-msg {
            font-size: 12px;
            color: var(--danger);
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 4px;
            background: #fef2f2;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #fee2e2;
        }

        button.calc-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        button.calc-btn:hover { background: #1d4ed8; }

        button.copy-btn {
            width: 100%;
            padding: 10px;
            margin-top: 15px;
            background: white;
            border: 1px solid var(--primary);
            color: var(--primary);
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }
        button.copy-btn:hover { background: #eff6ff; }

        canvas {
            max-width: 100%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            background: white;
            border: 1px solid #ccc;
            transition: height 0.3s ease; 
        }
        .visual-legend { margin-top: 15px; display: flex; gap: 15px; font-size: 12px; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 10px; height: 10px; border-radius: 2px; }

        .result-box {
            margin-top: 20px;
            padding: 15px;
            background: #eff6ff;
            border-radius: 8px;
            border: 1px solid #bfdbfe;
            display: none;
        }
        .result-box.show { display: block; }
        .total-price { font-size: 28px; font-weight: bold; color: var(--primary); text-align: center; margin-bottom: 10px;}
        .result-detail { font-size: 13px; color: #4b5563; border-top: 1px solid #dbeafe; padding-top: 10px; }
        .result-row { display: flex; justify-content: space-between; margin-bottom: 5px; }

        .hidden { display: none; }
        .section-title { font-size: 14px; font-weight: bold; color: #374151; margin-top: 15px; margin-bottom: 10px; border-left: 3px solid var(--primary); padding-left: 8px; }

        @media (max-width: 768px) {
            .content { flex-direction: column; }
            .visual-panel { border-left: none; border-top: 1px solid var(--border); }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-content">
            <!-- 
               LOGO æ”¾ç½®åŒºåŸŸ 
               1. è¯·å°† src æ›¿æ¢ä¸ºæ‚¨å…¬å¸çš„ Logo å›¾ç‰‡ URL (ä¾‹å¦‚: images/logo.png)
               2. ä¸‹æ–¹ç›®å‰ä½¿ç”¨äº†ä¸€ä¸ª SVG çŸ¢é‡å›¾ä½œä¸ºå ä½ç¬¦
            -->
            <img 
                src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiPjxwYXRoIGQ9Ik0xOSw4SDVjLTEuNjYsMC0zLDEuMzQtMywzdjZoMnY0aDE2djy0oMTl2LTFINjZIMTl6IE0xNiwyMkg4di01aDhWMjJ6IE0xOSwxMmctMS4xLDAtMi0uOS0yLTJzMC45LTIsMi0yczIsMC45LDIsMiBTMjAuMSwxMiwxOSwxMnoiLz48cGF0aCBkPSJNMTgsMS41SDZ2MmoxMloiLz48L3N2Zz4=" 
                class="logo-img" 
                alt="å…¬å¸Logo"
            >
            
            <div class="header-text">
                <h1>å°åˆ·æ™ºèƒ½æŠ¥ä»·ç³»ç»Ÿ</h1>
                <p>æ‹¼ç‰ˆè®¡ç®— | å·¥è‰ºçº¦æŸ | é•¿å·æ¨¡æ‹Ÿ</p>
            </div>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('digital')">å¹¿è‰²åŸŸå¿«å° (Sheet-Fed)</button>
        <button class="tab-btn" onclick="switchTab('giclee')">è‰ºæœ¯å¾®å–· (GiclÃ©e)</button>
    </div>

    <div class="content">
        <!-- å·¦ä¾§ï¼šè¡¨å•åŒº -->
        <div class="form-panel">
            
            <!-- å¿«å°è¡¨å• -->
            <div id="digital-form">
                <div class="form-group">
                    <label>æˆå“å°ºå¯¸ (mm)</label>
                    <div class="preset-tags">
                        <span class="tag" onclick="setDim(210, 297)">A4</span>
                        <span class="tag" onclick="setDim(148, 210)">A5</span>
                        <span class="tag" onclick="setDim(100, 148)">æ˜ä¿¡ç‰‡(A6)</span>
                        <span class="tag" onclick="setDim(89, 54)">å°å¡(3å¯¸)</span>
                    </div>
                    <div class="row">
                        <div class="col"><input type="number" id="d-w" placeholder="å®½" value="210"></div>
                        <div class="col"><input type="number" id="d-h" placeholder="é«˜" value="140"></div>
                    </div>
                    <div class="note">å«æ¯è¾¹2mmå‡ºè¡€ï¼Œç³»ç»Ÿè‡ªåŠ¨è®¡ç®—æ‹¼ç‰ˆé—´è·</div>
                </div>

                <div class="section-title">çº¸å¼ ä¸å°åˆ·</div>
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label>çº¸å¼ æè´¨</label>
                            <select id="d-paper" onchange="checkPaperConstraint()">
                                <option value="8" data-no-lam="false">300g é“œç‰ˆçº¸</option>
                                <option value="10" data-no-lam="false">400g é“œç‰ˆçº¸</option>
                                <option value="11" data-no-lam="true">300g è¶…æ„Ÿçº¸</option>
                                <option value="10" data-no-lam="true">300g çº¯æ£‰å¡çº¸</option>
                            </select>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>å°åˆ·é¢æ•°</label>
                            <select id="d-print-side">
                                <option value="0">å•é¢å°åˆ·</option>
                                <option value="2.5">åŒé¢å°åˆ·</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="section-title">è¦†è†œå·¥è‰º (æŒ‰å¤§å¼ é¢æ•°è®¡è´¹)</div>
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label>è¦†è†œç±»å‹</label>
                            <select id="d-lam-type" onchange="toggleLamSide()">
                                <option value="0">ä¸è¦†è†œ</option>
                                <option value="1.5">å“‘è†œ</option>
                                <option value="1.5">äº®è†œ</option>
                                <option value="2">è§¦æ„Ÿè†œ</option>
                                <option value="2">é•­å°„è†œ</option>
                            </select>
                            <div id="lam-warning" class="warn-msg hidden">
                                âš ï¸ æ­¤çº¸å¼ è¡¨é¢çº¹ç†ç‰¹æ®Šï¼Œæ— æ³•è¦†è†œ
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>è¦†è†œé¢æ•°</label>
                            <select id="d-lam-side" disabled>
                                <option value="1">å•é¢è¦†è†œ</option>
                                <option value="2">åŒé¢è¦†è†œ</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>å°åˆ·æ•°é‡ (æˆå“å¼ /ä»½æ•°)</label>
                    <input type="number" id="d-qty" value="100">
                </div>

                <button class="calc-btn" onclick="calculateDigital()">è®¡ç®—æŠ¥ä»·</button>
            </div>

            <!-- å¾®å–·è¡¨å• -->
            <div id="giclee-form" class="hidden">
                <div class="form-group">
                    <label>ç”»é¢å°ºå¯¸ (mm)</label>
                    <div class="preset-tags">
                        <span class="tag" onclick="setGDim(210, 297)">A4</span>
                        <span class="tag" onclick="setGDim(297, 420)">A3</span>
                        <span class="tag" onclick="setGDim(500, 500)">50x50cm</span>
                        <span class="tag" onclick="setGDim(610, 1000)">1ç±³é•¿å·</span>
                    </div>
                    <div class="row">
                        <div class="col"><input type="number" id="g-w" placeholder="å®½"></div>
                        <div class="col"><input type="number" id="g-h" placeholder="é«˜"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>çº¸å¼ æè´¨</label>
                    <select id="g-paper">
                        <option value="0.65">260å…‹ç»’é¢ç›¸çº¸</option>
                        <option value="0.7">æ³›å¤ªå…‹230å…‹å¢å¼ºç²—é¢çº¸</option>
                        <option value="0.9">æ³›å¤ªå…‹210å…‹èš€åˆ»çº¸</option>
                        <option value="2">æ³›å¤ªå…‹305å…‹ç¡«åŒ–é’¡è‰ºæœ¯çº¸</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æ•°é‡</label>
                    <input type="number" id="g-qty" value="1">
                </div>

                <button class="calc-btn" onclick="calculateGiclee()">è®¡ç®—æŠ¥ä»·</button>
            </div>

            <!-- ç»“æœå±•ç¤º -->
            <div id="result-box" class="result-box">
                <div class="total-price">Â¥<span id="price-val">0.00</span></div>
                <div class="result-detail" id="result-details"></div>
                <button class="copy-btn" id="copyBtn" onclick="copyToClipboard()">
                    <span>ğŸ“‹</span> å¤åˆ¶è¯¦ç»†æŠ¥ä»·å•
                </button>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå¯è§†åŒ–åŒº -->
        <div class="visual-panel">
            <label style="align-self: flex-start;">æ’ç‰ˆæ¨¡æ‹Ÿè§†å›¾</label>
            <canvas id="layoutCanvas" width="400" height="280"></canvas>
            
            <div id="digital-legend" class="visual-legend">
                <div class="legend-item"><div class="dot" style="background:#e0e7ff; border:1px solid #3b82f6;"></div>å‡ºè¡€ä½(+2mm)</div>
                <div class="legend-item"><div class="dot" style="background:#2563eb;"></div>æˆå“åŒº</div>
                <div class="legend-item"><div class="dot" style="background:#eee;"></div>3mmé—´è·</div>
            </div>
            
            <div style="margin-top:15px; font-size:12px; color:#666; text-align:left; width:100%; line-height:1.6;">
                <p id="desc-text"><strong>å¤§å¼ å‚æ•°è¯´æ˜ï¼š</strong><br>
                1. çº¸å¼ è§„æ ¼ï¼š733 x 510 mm<br>
                2. è®¡è´¹é€»è¾‘ï¼šæ€»ä»· = (çº¸å¼ å•ä»· + åŒé¢å°è´¹ + è¦†è†œè´¹) Ã— æ¶ˆè€—å¤§å¼ æ•°</p>
            </div>
        </div>
    </div>
</div>

<script>
    const D_MAX_W = 733;
    const D_MAX_H = 510;
    const BLEED_TOTAL = 4; 
    const GAP = 3; 
    const G_ROLL_W = 610;
    const G_MAX_PREVIEW_MM = 1000;

    const canvas = document.getElementById('layoutCanvas');
    const ctx = canvas.getContext('2d');
    let clipboardText = "";

    function setDim(w, h) {
        document.getElementById('d-w').value = w;
        document.getElementById('d-h').value = h;
    }
    function setGDim(w, h) {
        document.getElementById('g-w').value = w;
        document.getElementById('g-h').value = h;
    }

    function checkPaperConstraint() {
        const paperSelect = document.getElementById('d-paper');
        const selectedOption = paperSelect.options[paperSelect.selectedIndex];
        const noLam = selectedOption.getAttribute('data-no-lam') === 'true';

        const lamTypeSelect = document.getElementById('d-lam-type');
        const lamSideSelect = document.getElementById('d-lam-side');
        const warnMsg = document.getElementById('lam-warning');

        if (noLam) {
            lamTypeSelect.value = "0"; 
            lamTypeSelect.disabled = true;
            lamSideSelect.disabled = true;
            warnMsg.classList.remove('hidden');
        } else {
            lamTypeSelect.disabled = false;
            warnMsg.classList.add('hidden');
            toggleLamSide();
        }
    }

    function toggleLamSide() {
        const type = document.getElementById('d-lam-type').value;
        const sideSelect = document.getElementById('d-lam-side');
        sideSelect.disabled = (type == "0");
    }

    function switchTab(mode) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('digital-form').classList.add('hidden');
        document.getElementById('giclee-form').classList.add('hidden');
        document.getElementById('result-box').classList.remove('show');
        ctx.clearRect(0,0,canvas.width, canvas.height);
        canvas.height = 280; 

        if (mode === 'digital') {
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            document.getElementById('digital-form').classList.remove('hidden');
            document.getElementById('digital-legend').classList.remove('hidden');
            document.getElementById('desc-text').innerHTML = `<strong>å¤§å¼ å‚æ•°è¯´æ˜ï¼š</strong><br>1. çº¸å¼ è§„æ ¼ï¼š733 x 510 mm<br>2. ç³»ç»Ÿä¼˜å…ˆåŒ¹é…æœ€çœçº¸çš„æ—‹è½¬æ–¹å‘ã€‚`;
        } else {
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            document.getElementById('giclee-form').classList.remove('hidden');
            document.getElementById('digital-legend').classList.add('hidden');
            document.getElementById('desc-text').innerHTML = `<strong>å¾®å–·é¢„è§ˆè¯´æ˜ï¼š</strong><br>1. é¢„è§ˆå›¾æœ€å¤§æ˜¾ç¤ºé•¿åº¦ä¸º 100cm<br>2. è¶…è¿‡éƒ¨åˆ†å°†è¢«éšè—ï¼Œä½†ä»·æ ¼è®¡ç®—ä¸å—å½±å“ã€‚`;
        }
    }

    // --- å¿«å°é€»è¾‘ ---
    function calculateDigital() {
        const w = parseFloat(document.getElementById('d-w').value);
        const h = parseFloat(document.getElementById('d-h').value);
        const qty = parseInt(document.getElementById('d-qty').value);
        
        if(!w || !h || !qty) return alert("è¯·è¾“å…¥å®Œæ•´å°ºå¯¸å’Œæ•°é‡");

        const paperEl = document.getElementById('d-paper');
        const paperPrice = parseFloat(paperEl.value);
        const paperName = paperEl.options[paperEl.selectedIndex].text.split('(')[0].trim();
        const printSideCost = parseFloat(document.getElementById('d-print-side').value);
        const printSideName = document.getElementById('d-print-side').options[document.getElementById('d-print-side').selectedIndex].text.split('(')[0].trim();
        
        const lamTypeEl = document.getElementById('d-lam-type');
        const lamPrice = parseFloat(lamTypeEl.value); 
        const lamName = lamTypeEl.options[lamTypeEl.selectedIndex].text.split('(')[0].trim();
        const lamSideCount = parseInt(document.getElementById('d-lam-side').value);
        
        let costPerSheet = paperPrice + printSideCost;
        if (lamPrice > 0) costPerSheet += (lamPrice * lamSideCount);

        const unitW = w + BLEED_TOTAL;
        const unitH = h + BLEED_TOTAL;

        function calcFit(cont, item) {
            if (item > cont) return 0;
            return Math.floor((cont + GAP) / (item + GAP));
        }

        const colsA = calcFit(D_MAX_W, unitW);
        const rowsA = calcFit(D_MAX_H, unitH);
        const totalA = colsA * rowsA;

        const colsB = calcFit(D_MAX_W, unitH);
        const rowsB = calcFit(D_MAX_H, unitW);
        const totalB = colsB * rowsB;

        let bestCount, bestCols, bestRows, isRotated;
        if (totalA >= totalB && totalA > 0) {
            bestCount = totalA; bestCols = colsA; bestRows = rowsA; isRotated = false;
        } else {
            bestCount = totalB; bestCols = colsB; bestRows = rowsB; isRotated = true;
        }

        if (bestCount === 0) return alert(`å°ºå¯¸è¿‡å¤§ï¼å•å¼ (å«å‡ºè¡€)è¶…è¿‡ ${D_MAX_W}x${D_MAX_H}mm`);

        const totalSheets = Math.ceil(qty / bestCount);
        const totalPrice = totalSheets * costPerSheet;

        let finishStr = printSideName;
        if (lamPrice > 0) finishStr += ` + ${lamName}(${lamSideCount===1?"å•é¢":"åŒé¢"})`;
        else finishStr += " + æ— è¦†è†œ";

        showResult(totalPrice, [
            { k: "æˆå“è§„æ ¼", v: `${w}x${h}mm` },
            { k: "çº¸å¼ æè´¨", v: paperName },
            { k: "å°åˆ·å·¥è‰º", v: finishStr },
            { k: "æ‹¼ç‰ˆæ–¹å¼", v: `${isRotated ? "æ—‹è½¬" : "æ­£å¸¸"} (1å¤§å¼ å°${bestCount}ä¸ª)` },
            { k: "æ¶ˆè€—çº¸å¼ ", v: `${totalSheets} å¤§å¼ ` },
            { k: "å•å¼ æˆæœ¬", v: `Â¥${costPerSheet.toFixed(2)}` },
            { k: "æ€»ä»·", v: `Â¥${totalPrice.toFixed(2)}` }
        ]);

        clipboardText = `ã€å°åˆ·è¯¢ä»·å•ã€‘\nç±»å‹ï¼šå¹¿è‰²åŸŸå¿«å°\nå°ºå¯¸ï¼š${w}x${h}mm\næ•°é‡ï¼š${qty}å¼ \næè´¨ï¼š${paperName}\nå·¥è‰ºï¼š${finishStr}\n----------------\næ‹¼ç‰ˆï¼š1å°${bestCount}\nè€—æï¼š${totalSheets}å¤§å¼ \n----------------\né¢„ä¼°æ€»ä»·ï¼šÂ¥${totalPrice.toFixed(2)}`;

        const drawW = isRotated ? h : w;
        const drawH = isRotated ? w : h;
        drawDigitalLayout(bestCols, bestRows, drawW, drawH);
    }

    function drawDigitalLayout(cols, rows, itemW, itemH) {
        const scale = canvas.width / D_MAX_W;
        canvas.height = D_MAX_H * scale;

        ctx.fillStyle = '#e5e7eb'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#9ca3af'; ctx.setLineDash([5, 5]); ctx.strokeRect(0, 0, canvas.width, canvas.height); ctx.setLineDash([]);

        const unitW = itemW + BLEED_TOTAL;
        const unitH = itemH + BLEED_TOTAL;
        const contentW = cols * unitW + (cols - 1) * GAP;
        const contentH = rows * unitH + (rows - 1) * GAP;
        const startX = (D_MAX_W - contentW) / 2;
        const startY = (D_MAX_H - contentH) / 2;

        for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
                let x = (startX + c * (unitW + GAP)) * scale;
                let y = (startY + r * (unitH + GAP)) * scale;
                
                ctx.fillStyle = '#eff6ff'; ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 1;
                ctx.fillRect(x, y, unitW*scale, unitH*scale);
                ctx.strokeRect(x, y, unitW*scale, unitH*scale);

                ctx.fillStyle = '#2563eb';
                ctx.fillRect(x + 2*scale, y + 2*scale, itemW*scale, itemH*scale);
            }
        }
    }

    // --- å¾®å–·é€»è¾‘ ---
    function calculateGiclee() {
        const w = parseFloat(document.getElementById('g-w').value);
        const h = parseFloat(document.getElementById('g-h').value);
        const qty = parseInt(document.getElementById('g-qty').value);
        const paperEl = document.getElementById('g-paper');
        const pricePerCm = parseFloat(paperEl.value);
        const paperName = paperEl.options[paperEl.selectedIndex].text.split('(')[0].trim();

        if(!w || !h || !qty) return alert("è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯");
        if(Math.min(w, h) > G_ROLL_W) return alert("å°ºå¯¸è¶…å®½ (é™610mm)");

        let costLenA = Infinity, costLenB = Infinity;
        if(w <= G_ROLL_W) costLenA = Math.ceil(qty / Math.floor(G_ROLL_W / w)) * h;
        if(h <= G_ROLL_W) costLenB = Math.ceil(qty / Math.floor(G_ROLL_W / h)) * w;

        let usedLenMm = Math.min(costLenA, costLenB);
        let totalPrice = (usedLenMm / 10) * pricePerCm;
        let layoutType = (costLenA <= costLenB) ? 'A' : 'B';
        let layoutStr = (layoutType === 'A') ? "æ¨ªæ’ (æ¶ˆè€—é«˜åº¦)" : "ç«–æ’ (æ¶ˆè€—å®½åº¦)";

        showResult(totalPrice, [
            { k: "ç”»é¢å°ºå¯¸", v: `${w} x ${h} mm` },
            { k: "çº¸å¼ æè´¨", v: paperName },
            { k: "æ’ç‰ˆæ–¹å¼", v: layoutStr },
            { k: "æ¶ˆè€—å·é•¿", v: `${(usedLenMm/10).toFixed(1)} cm` },
            { k: "æ€»ä»·", v: `Â¥${totalPrice.toFixed(2)}` }
        ]);

        clipboardText = `ã€å°åˆ·è¯¢ä»·å•ã€‘\nç±»å‹ï¼šè‰ºæœ¯å¾®å–·\nå°ºå¯¸ï¼š${w}x${h}mm\næè´¨ï¼š${paperName}\næ•°é‡ï¼š${qty}ä»½\n----------------\næ’ç‰ˆï¼š${layoutStr}\nè€—æï¼š${(usedLenMm/10).toFixed(1)} cm\n----------------\né¢„ä¼°æ€»ä»·ï¼šÂ¥${totalPrice.toFixed(2)}`;

        drawGicleeLayout(layoutType, w, h, qty);
    }

    function drawGicleeLayout(type, w, h, qty) {
        const scale = canvas.width / G_ROLL_W;
        
        const itemDrawW_mm = (type === 'A' ? w : h);
        const itemDrawH_mm = (type === 'A' ? h : w);
        const perRow = Math.floor(G_ROLL_W / itemDrawW_mm);
        const totalRows = Math.ceil(qty / perRow);
        const totalHeightMm = totalRows * itemDrawH_mm;
        
        let displayHeightMm = totalHeightMm;
        let isTruncated = false;
        if (totalHeightMm > G_MAX_PREVIEW_MM) {
            displayHeightMm = G_MAX_PREVIEW_MM;
            isTruncated = true;
        }

        const headerH = 40;
        const footerH = isTruncated ? 60 : 30;
        canvas.height = headerH + (displayHeightMm * scale) + footerH;

        ctx.fillStyle = '#e5e7eb'; ctx.fillRect(0,0, canvas.width, canvas.height);
        ctx.fillStyle = '#666'; ctx.font = '14px Arial'; ctx.textAlign = 'center';
        ctx.fillText("å·ç­’çº¸å®½åº¦ 610mm (è¿ç»­è¿›çº¸)", canvas.width/2, 25);

        let startY = headerH; 
        let currentHeightMm = 0; 

        for(let r=0; r<totalRows; r++) {
            if (currentHeightMm + itemDrawH_mm > displayHeightMm && isTruncated) break;

            for(let c=0; c<perRow; c++) {
                if (r * perRow + c >= qty) break;
                let x = c * itemDrawW_mm * scale;
                let y = startY + (r * itemDrawH_mm * scale);
                
                ctx.fillStyle = '#10b981'; ctx.strokeStyle = '#fff';
                ctx.fillRect(x, y, itemDrawW_mm * scale, itemDrawH_mm * scale);
                ctx.strokeRect(x, y, itemDrawW_mm * scale, itemDrawH_mm * scale);
            }
            currentHeightMm += itemDrawH_mm;
        }

        if (isTruncated) {
            const bottomY = canvas.height - footerH;
            let gradient = ctx.createLinearGradient(0, bottomY - 50, 0, canvas.height);
            gradient.addColorStop(0, "rgba(229, 231, 235, 0)");
            gradient.addColorStop(0.8, "rgba(229, 231, 235, 1)");
            ctx.fillStyle = gradient; ctx.fillRect(0, bottomY - 50, canvas.width, footerH + 50);

            ctx.strokeStyle = '#f59e0b'; ctx.lineWidth = 2; ctx.setLineDash([10, 5]);
            ctx.beginPath(); ctx.moveTo(0, bottomY); ctx.lineTo(canvas.width, bottomY); ctx.stroke(); ctx.setLineDash([]);

            ctx.fillStyle = '#b45309'; ctx.font = 'bold 12px Arial';
            ctx.fillText(`âš ï¸ é¢„è§ˆå·²æˆªæ–­ (å®é™… ${(totalHeightMm/1000).toFixed(2)}ç±³)`, canvas.width/2, bottomY + 25);
        } else {
            let endY = headerH + totalHeightMm * scale;
            ctx.strokeStyle = '#9ca3af'; ctx.setLineDash([5, 5]);
            ctx.beginPath(); ctx.moveTo(0, endY); ctx.lineTo(canvas.width, endY); ctx.stroke();
            ctx.fillStyle = '#666'; ctx.font = '12px Arial';
            ctx.fillText(`æ€»é•¿åº¦ ${(totalHeightMm/10).toFixed(1)} cm`, canvas.width/2, endY + 20);
        }
    }

    function showResult(price, details) {
        document.getElementById('result-box').classList.add('show');
        document.getElementById('price-val').innerText = price.toFixed(2);
        
        const html = details.map(d => `
            <div class="result-row">
                <span>${d.k}</span>
                <span style="font-weight:600">${d.v}</span>
            </div>
        `).join('');
        document.getElementById('result-details').innerHTML = html;
        
        const btn = document.getElementById('copyBtn');
        btn.innerHTML = '<span>ğŸ“‹</span> å¤åˆ¶è¯¦ç»†æŠ¥ä»·å•';
        btn.style.background = 'white'; btn.style.color = 'var(--primary)';
    }

    function copyToClipboard() {
        if (!clipboardText) return;
        navigator.clipboard.writeText(clipboardText).then(() => {
            const btn = document.getElementById('copyBtn');
            btn.innerHTML = '<span>âœ…</span> å·²å¤åˆ¶ï¼';
            btn.style.background = '#ecfdf5'; btn.style.color = '#059669';
            setTimeout(() => {
                btn.innerHTML = '<span>ğŸ“‹</span> å¤åˆ¶è¯¦ç»†æŠ¥ä»·å•';
                btn.style.background = 'white'; btn.style.color = 'var(--primary)';
            }, 2000);
        });
    }
</script>

</body>
</html>